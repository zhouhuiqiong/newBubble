<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>无标题文档</title>
</head>
<script type="text/javascript" src="jquery-1.10.2.min.js"></script>

<link rel="stylesheet" href="calendar_2/jquery.datetimepicker.css" type="text/css"> 
<script type="text/javascript" charset="utf-8" src="calendar_2/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="calendar_2/build/jquery.datetimepicker.full.js"></script>
<body >
	 <input name="posttime1" type="text" id="posttime1" class="input-text posttime"   value="请选择时间"/>
</body>
</html>
<script type="text/javascript">
	$(function(){
		var util = {};
		function YuTime(opts){
			var that = this;
			that.opts = $.extend({
				yuStartTime: '18:30',//营业时间
				yuEndTime: '03:30',//营业结束时间
				gap: 15,//最大预约时间断天数
				joint: '-',//时间拼接符号
				startAheadTime: 30,//最早可选时间为当前系统时间加30分后最近的半点
				endAheadTime: 1 //最晚可选时间为该服务营业时间之前1小时
			},opts);
		}
		YuTime.prototype = {
			init: function(){
				var that = this;
				that.tager = that;
				that.nowTime();
				that.loadPicker();
			},
			nowTime: function(){
				var that = this,opts = that.opts;
				that.nowDate = new Date();
				var y = that.nowYear = that.nowDate.getFullYear();
				var m = that.nowMonth = that.nowDate.getMonth();
				var d = that.nowDay = that.nowDate.getDate();
				that.nowHour = that.nowDate.getHours();
				that.nowMinutes = that.nowDate.getMinutes();
				that.startYingTime = that.jointTime(y,m,d);
				//15天后
				that.endDate = new Date();
				that.endDate.setDate(that.nowDay + opts.gap);
				var ey = that.endYear = that.endDate.getFullYear();
				var em = that.endMonth = that.endDate.getMonth();
				var ed = that.endDate = that.endDate.getDate();
				that.endYingTime =  that.jointTime(ey,em,ed);
			},
			jointTime: function(y,m,d){//拼接时间格式
				var that = this,opts = that.opts;
				var str = y + opts.joint + that.initStr(m+1) + opts.joint + that.initStr(d);
				return str;
			},
			initStr: function(str){
				return str > 9 ? str : '0' + str;
			},
			splitTime: function(time){//小时与分钟分开
				var str = time.split(':'),
					h = parseInt(str[0]),
					m = parseInt(str[1]);
				return {
					h: h,
					m: m
				}
			},
			initHourStyle: function(changeTime){//初始化
				var that = this;
				that.initHour(changeTime);
			},
			setChangeStyle: function(changeTime){//选中
				var that = this;
				that.initHour(changeTime);
			},
			initHour: function(val){
				var that = this,opts = that.opts;
				var time = new Date(val);
				var changeDate = time.getDate();
				that.isnowData = false;//是不是当前天
				if(changeDate == that.nowDay){//选中的是当天
					that.isnowData = true;
					that.yuStartObj = that.splitTime(opts.yuStartTime);
					if(that.yuStartObj.h <= that.nowHour){//预约时间大于系统时间
						if(that.nowMinutes == 0 ){
							that.yuStartH = that.nowHour;
						}else{
							that.yuStartH = that.nowHour + opts.endAheadTime;
						};
					}else{
						that.yuStartH = that.yuStartObj.h;
					};
					setTimeout(function(){
						that.hourStyleHandle();
					},100);
				}else if(changeDate > that.nowDay){//选中的不是当天
					that.yuEndObj = that.splitTime(opts.yuStartTime);
					that.yuStartTime = that.splitTime(opts.yuEndTime);
					setTimeout(function(){
						that.calculate();
					},100);

				};
			},
			calculate: function(){
				var that = this;
				var $obj = $('.xdsoft_time_variant>div'),
					opts = that.opts;
					var start = that.yuStartTime.h - opts.endAheadTime;
 					$obj.each(function(){
 						var h = $(this).attr('data-hour');
						if(h < that.yuEndObj.h && h >= start){
							$(this).addClass('xdsoft_disabled');
						}; 
						if((h == that.yuEndObj.h) && that.yuEndObj.m){
							if($(this).attr('data-minute') == '0'){
								$(this).addClass('xdsoft_disabled');
							};
						};
						if(h == start){
							if(that.yuStartTime.m){
								$(this).removeClass('xdsoft_disabled');
							}else{
								if($(this).attr('data-minute') == '0'){
									$(this).removeClass('xdsoft_disabled');
								};
							}
						};
						
					});
			},
			hourStyleHandle: function(){
				var that = this;
				var $obj = $('.xdsoft_time_variant>div');
 					$obj.each(function(){
						if($(this).attr('data-hour') < that.yuStartH){
							$(this).addClass('xdsoft_disabled');
						};
					});
			},
			initSetInput: function(changeTime,obj){//点击天的小时初始化
				var that = this;
				var $obj = $('.xdsoft_time_variant>div');
				that.initHm = '00:00';
				that.isExist = false;
				var data = new Date(changeTime);
				var changeDate = data.getDate();
				if(changeDate == that.nowDay){
					that.isExist = hasDisabled();
				};
				function hasDisabled(){
					$('.xdsoft_time_variant>div').each(function(){
						if(!$(this).hasClass('xdsoft_disabled')){
							that.initHm = $(this).text();							
							return false;
						};
					});
					return true;
				}
				var tian = that.isExist ?   1 : 0;
				var y = data.getFullYear();
				var m = data.getMonth();
				var d = data.getDate() + tian;
				var str = y + '/' + that.initStr(m+1) + '/' + that.initStr(d)+' ' + that.initHm;
				return str;
			},
			loadPicker: function(){
				var that = this;
				$.datetimepicker.setLocale('zh');	
				$('.posttime').datetimepicker({
					onChangeDateTime: function(changeTime){
						that.initHourStyle(changeTime);
					},
					onShow: function(changeTime){
						that.initHourStyle(changeTime);
					},
					dateFormat: 'yy-mm-dd',
					minDate: that.startYingTime,
					maxDate: that.endYingTime,
					onSelectDate: function(changeTime){
						var str = that.initSetInput(changeTime);
						$('.posttime').val(str);
					},
					step: 30
				});
			}
		}
		util.yuTime = YuTime;
		new util.yuTime().init();
	})
</script>